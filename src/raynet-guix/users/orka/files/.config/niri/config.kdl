// Niri configuration file (KDL)

// --- Startup Services ---
spawn-at-startup "fcitx5" "-d"
spawn-at-startup "waybar"
spawn-at-startup "hypridle"
spawn-at-startup "swww-daemon"
spawn-sh-at-startup "swww img ~/.config/niri/wallpaper.jpg"
spawn-sh-at-startup "~/.nix-profile/bin/hyprlax ~/.config/niri/wallpaper.jpg"
spawn-at-startup "swaync"

// --- General Settings ---
hotkey-overlay {
    skip-at-startup
}

prefer-no-csd
screenshot-path "~/Pictures/Screenshots/%Y-%m-%d %H-%M-%S.png"

overview {
    workspace-shadow {
        off
    }
}

cursor {
    hide-when-typing
    hide-after-inactive-ms 5000
}

// --- Layer Rules ---
// Waybar should stay on top
layer-rule {
    match namespace="^waybar$"
}

// Hyprlax layer rule for parallax
layer-rule {
    match namespace="^hyprlax$"
    place-within-backdrop true
}

// SwayNC notifications
layer-rule {
    match namespace="^swaync$"
}

// --- Layout & Visuals ---
layout {
    gaps 12
    center-focused-column "never"
    
    preset-column-widths {
        proportion 0.33333
        proportion 0.5
        proportion 0.66667
    }
    
    default-column-width { proportion 0.5; }
    
    focus-ring {
        width 2
        active-color "#7aa2f7"
        inactive-color "#414868"
    }

    border {
        off
    }

    insert-hint {
        color "#7aa2f7"
    }
}

// --- Animations ---
animations {
    workspace-switch {
        spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
    }
    window-open {
        duration-ms 200
        curve "ease-out-quad"
    }
    window-close {
        duration-ms 200
        curve "ease-out-cubic"
    }
    horizontal-view-movement {
        spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
    }
    window-movement {
        spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
    }
    window-resize {
        spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
    }
    config-notification-open-close {
        spring damping-ratio=0.6 stiffness=1200 epsilon=0.001
    }
    screenshot-ui-open {
        duration-ms 300
        curve "ease-out-quad"
    }
    overview-open-close {
        spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
    }
}

// --- Keybindings ---
binds {
    // Shortcuts Panel
    Mod+Shift+Slash { show-hotkey-overlay; }

    // Launcher: Fuzzel (Guix home)
    Mod+D hotkey-overlay-title="App Launcher: Fuzzel" { spawn "fuzzel"; }
    Mod+Ctrl+L hotkey-overlay-title="Lock Screen" { spawn "hyprlock"; }
    
    // Standard Niri Controls
    Mod+Q hotkey-overlay-title="Close Window" { close-window; }
    //Mod+Return hotkey-overlay-title="Open Terminal" { spawn "/home/orka/.guix-home/profile/bin/ghostty"; }
    Mod+Return hotkey-overlay-title="Open Terminal: Ghostty" { spawn "ghostty"; }
    Mod+Ctrl+Return hotkey-overlay-title="Open Terminal: Ghostty" { spawn "alacritty"; }
    Mod+Shift+E hotkey-overlay-title="Logout Menu" { spawn "wlogout"; }
    Mod+Ctrl+Shift+E hotkey-overlay-title="Quit Niri" { quit; }
    
    // Navigation
    Mod+Left  hotkey-overlay-title="Focus Left"  { focus-column-left; }
    Mod+Right hotkey-overlay-title="Focus Right" { focus-column-right; }
    Mod+Up    hotkey-overlay-title="Focus Workspace Up"    { focus-workspace-up; }
    Mod+Down  hotkey-overlay-title="Focus Workspace Down"  { focus-workspace-down; }
    Mod+H     hotkey-overlay-title="Focus Left"  { focus-column-left; }
    Mod+J     hotkey-overlay-title="Focus Workspace Down" { focus-workspace-down; }
    Mod+K     hotkey-overlay-title="Focus Workspace Up"   { focus-workspace-up; }
    Mod+L     hotkey-overlay-title="Focus Right" { focus-column-right; }
    
    // Overview / Workspace navigation
    Mod+O hotkey-overlay-title="Toggle Overview" { toggle-overview; }

    // Moving Windows
    Mod+Shift+Left  hotkey-overlay-title="Move Left"  { move-column-left; }
    Mod+Shift+Right hotkey-overlay-title="Move Right" { move-column-right; }
    Mod+Shift+Up    hotkey-overlay-title="Move to Workspace Up"    { move-column-to-workspace-up; }
    Mod+Shift+Down  hotkey-overlay-title="Move to Workspace Down"  { move-column-to-workspace-down; }
    Mod+Shift+H     hotkey-overlay-title="Move Left"  { move-column-left; }
    Mod+Shift+J     hotkey-overlay-title="Move to Workspace Down" { move-column-to-workspace-down; }
    Mod+Shift+K     hotkey-overlay-title="Move to Workspace Up"   { move-column-to-workspace-up; }
    Mod+Shift+L     hotkey-overlay-title="Move Right" { move-column-right; }
    
    // Layout Management
    Mod+R hotkey-overlay-title="Cycle Column Width" { switch-preset-column-width; }
    Mod+F hotkey-overlay-title="Maximize Column" { maximize-column; }
    Mod+Shift+F hotkey-overlay-title="Fullscreen Window" { fullscreen-window; }
    Mod+C hotkey-overlay-title="Center Column" { center-column; }

    // Resizing
    Mod+BracketLeft  hotkey-overlay-title="Narrow Column" { set-column-width "-10%"; }
    Mod+BracketRight hotkey-overlay-title="Widen Column"  { set-column-width "+10%"; }

    // Audio/Media keys
    XF86AudioRaiseVolume hotkey-overlay-title="Volume Up"   { spawn "flatpak" "run" "com.saivert.pwvucontrol"; }
    XF86AudioLowerVolume hotkey-overlay-title="Volume Down" { spawn "flatpak" "run" "com.saivert.pwvucontrol"; }
    XF86AudioMute        hotkey-overlay-title="Mute Audio"  { spawn "flatpak" "run" "com.saivert.pwvucontrol"; }

    // Workspace Management
    Mod+1 { focus-workspace 1; }
    Mod+2 { focus-workspace 2; }
    Mod+3 { focus-workspace 3; }
    Mod+4 { focus-workspace 4; }
    Mod+5 { focus-workspace 5; }
    Mod+6 { focus-workspace 6; }
    Mod+7 { focus-workspace 7; }
    Mod+8 { focus-workspace 8; }
    Mod+9 { focus-workspace 9; }

    Mod+Shift+1 { move-column-to-workspace 1; }
    Mod+Shift+2 { move-column-to-workspace 2; }
    Mod+Shift+3 { move-column-to-workspace 3; }
    Mod+Shift+4 { move-column-to-workspace 4; }
    Mod+Shift+5 { move-column-to-workspace 5; }
    Mod+Shift+6 { move-column-to-workspace 6; }
    Mod+Shift+7 { move-column-to-workspace 7; }
    Mod+Shift+8 { move-column-to-workspace 8; }
    Mod+Shift+9 { move-column-to-workspace 9; }

    Mod+Tab hotkey-overlay-title="Previous Workspace" { focus-workspace-previous; }
}

// --- Window Rules ---
// Application-specific rules
window-rule {
    match is-active=false
    opacity 0.95
}

window-rule {
    match app-id=r#"firefox"#
    match app-id=r#"google-chrome"#
    match app-id=r#"code"#
    open-maximized true
}

// File dialogs - Open/Save/Select
window-rule {
    match title=r#".*(Open|Save|Select).*"#
    match app-id=r#"org\.gtk\.FileChooserDialog"#
    match title=r#".*File.*"#
    open-floating true
    max-width 800
    max-height 1000
}

// Authentication & System dialogs
window-rule {
    match title=r#".*(Dialog|Properties|Preferences|Settings|Rename).*"#
    match title=r#".*Authentication.*"#
    match app-id=r#"zenity"#
    match app-id=r#"org\.kde\.polkit-kde-authentication-agent-1"#
    open-floating true
}

window-rule {
    match app-id=r#"pavucontrol"#
    match app-id=r#"nm-connection-editor"#
    match app-id=r#"blueman-manager"#
    open-floating true
}

// Global window appearance
window-rule {
    geometry-corner-radius 8
    clip-to-geometry true
}

// --- Input ---
input {
    keyboard {
        xkb {
            layout "kr"
        }
    }

    touchpad {
        tap
        natural-scroll
    }

    //focus-follows-mouse
    workspace-auto-back-and-forth
}

// --- Outputs ---
output "eDP-1" {
    scale 1.0
}

// --- Environment ---
environment {
    ELECTRON_OZONE_PLATFORM_HINT "auto"
    XDG_SESSION_TYPE "wayland"
    XDG_CURRENT_DESKTOP "niri"
    MOZ_ENABLE_WAYLAND "1"

    // Additional Wayland Platform Settings
    QT_QPA_PLATFORM "wayland"
    QT_QPA_PLATFORMTHEME "gtk3"
    QT_WAYLAND_DISABLE_WINDOWDECORATION "1"
    SDL_VIDEODRIVER "wayland"
    CLUTTER_BACKEND "wayland"
    GDK_BACKEND "wayland,x11"
}
